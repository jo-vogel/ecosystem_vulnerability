---
title: "Vulnerability_analysis"
author: "Johannes Vogel"
date: "23 6 2020"
output: html_document
params:
  perc: 2 # which of the three percentiles to pick (0.05, 0.10, 0.15)
  ind: 4 # "4" signifies deseasonalised and z-scored with 3 months moving window
  time_lag_dri: 0 # time lag of driver
  time_lag_imp: 0 # time lag of impact
  vsw: FALSE # T: pick ESA CCI soil moisture, F: pick ERA5 Land soil moisture
  mv3_driver_only: TRUE # T: moving window only for driver, not impact, F: moving window for both
  seasonal: FALSE # T: seasonal maps, F: monthly maps
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
library(pbapply)
library(raster)
library(viridis)
library(RColorBrewer)
library(rgdal)
require(colorplaner)
require(ggplot2)
library(cowplot)
library(tidyverse)
library(rasterVis)
library(ggpubr)
library(scales)
```

```{r Load data, include = F}
path_data <- message("insert path here")
path_workspaces <- message("insert path here")
path_data <- "D:/Local/Data/"
path_workspaces <- "C:/Users/vogel/boxup/Promotion/Impact_analysis/Code/Workspaces/"
load(file=paste0(path_workspaces,"Preprocessed_data.RData")) # Preprocessed data from Preprocessing.r
border <- readOGR(paste0(path_data,'GIS_data/ne_50m_admin_0_countries/ne_50m_admin_0_countries.shp')) # from https://www.naturalearthdata.com/downloads/50m-cultural-vectors/50m-admin-0-countries-2/
sm_monthly_brick <- brick(paste0(path_workspaces,"sm79_19_monthly.nc", varname="sm")) # created with cdo
load(file=paste0(path_workspaces,"Regional_indices.RData")) # from Regional_comparisons.r
load(file = paste0(path_workspaces,"Landcovers.RData")) # from Land_cover.Rmd
# Reduced set where pixels with land cover change are excluded
load(file=paste0(path_workspaces,"locat_red.RData")) # from Land_cover.Rmd
locat <- locat_red
lcs <- lcs_red
reg_id <- reg_id_red
lcs_aggr <- lcs_aggr_red
locat <- locat[lcs_aggr_red!="Water bodies" & lcs_aggr_red!="Urban areas"] # exclude Water bodies and Urban areas
lcs <- lcs[lcs_aggr_red!="Water bodies" & lcs_aggr_red!="Urban areas"]
reg_id <- reg_id[lcs_aggr_red!="Water bodies" & lcs_aggr_red!="Urban areas"]
lcs_aggr <- lcs_aggr[lcs_aggr_red!="Water bodies" & lcs_aggr_red!="Urban areas"]

if (params$vsw){
  sm_list <- vsw_list # change from ESA CCI soil moisture data to ERA5 Land
  percentiles[6:10] <- percentiles[11:15]
}

if (params$mv3_driver_only){
  fapar_list[[4]] <- fapar_list[[2]] # moving window for drivers only, pick version without moving window for impact variable
  names(fapar_list)[4] <- "fapar_des_z"
  percentiles[["percentiles_fapar_des_z_mv3"]] <- percentiles[["percentiles_fapar_des_z"]]
  names(percentiles)[14] <- "percentiles_fapar_des_z"
}
```

```{r Vulnerability analysis, eval=T}

locat_all <- locat

p_temp_all <- vector("list",12) # empty raster stack
p_sm_all <- vector("list",12) # empty raster stack

message("Pick season or month here")
# for(seas_num in 1:4){ # Seasonal
for(seas_num in 1:12){ # Monthly
  if (params$seasonal){
    message("pick a season")
    if (seas_num==1){
      # season_months <- c(3,4,5)
      season_months <- c(2,3,4)
      print("Season: Spring")
      # season <- "a) Spring"
      season <- "a) Feb - Apr"
    } else if (seas_num==2){
      # season_months <- c(6,7,8)
      season_months <- c(5,6,7)
      print("Season: Summer")
      # season <- "b) Summer"
      season <- "b) May - Jul"
    } else if (seas_num==3){
      # season_months <- c(9,10,11)
      season_months <- c(8,9,10)
      print("Season: Autumn")
      # season <- "c) Autumn"
      season <- "c) Aug - Oct"
    } else if (seas_num==4){
      # season_months <- c(12,1,2)
      season_months <- c(11,12,1)
      print("Season: Winter")
      # season <- "d) Winter"
      season <- "d) Nov - Jan"
    } else if (seas_num==5){
      message("All seasons")
    }
  } else {
      if (seas_num==1){
      season_months <- c(1)
      print("Month: Jan")
      season <- "(a) Jan"
      sea <- "Jan"
    } else if (seas_num==2){
      season_months <- c(2)
      print("Month: Feb")
      season <- "(b) Feb"
      sea <- "Feb"
    } else if (seas_num==3){
      season_months <- c(3)
      print("Month: Mar")
      # season <- "c) Mar" # 12-month plot
      season <- "(a) Mar" # 4-month plot
      sea <- "Mar"
    } else if (seas_num==4){
      season_months <- c(4)
      print("Month: Apr")
      # season <- "d) Apr" # 12-month plot
      season <- "(c) Apr" # 8-month plot
      sea <- "Apr"
    } else if (seas_num==5){
      season_months <- c(5)
      print("Month: May")
      # season <- "e) May" # 12-month plot
      season <- "(d) May" # 8-month plot
      sea <- "May"
    } else if (seas_num==6){
      season_months <- c(6)
      print("Month: Jun")
      # season <- "f) Jun" # 12-month plot
      season <- "(b) Jun" # 4-month plot
      sea <- "Jun"
    } else if (seas_num==7){
      season_months <- c(7)
      print("Month: Jul")
      # season <- "g) Jul" # 12-month plot
      season <- "(e) Jul" # 8-month plot
      sea <- "Jul"
    } else if (seas_num==8){
      season_months <- c(8)
      print("Month: Aug")
      # season <- "h) Aug" # 12-month plot
      season <- "(f) Aug" # 8-month plot
      sea <- "Aug"
    } else if (seas_num==9){
      season_months <- c(9)
      print("Month: Sep") 
      # season <- "i) Sep" # 12-month plot
      season <- "(c) Sep" # 4-month plot
      sea <- "Sep"
    } else if (seas_num==10){
      season_months <- c(10)
      print("Month: Oct")
      # season <- "j) Oct" # 12-month plot
      season <- "(g) Oct" # 8-month plot
      sea <- "Oct"
    } else if (seas_num==11){
      season_months <- c(11)
      print("Month: Nov") 
      # season <- "k) Nov" # 12-month plot
      season <- "(h) Nov" # 8-month plot
      sea <- "Nov"
    } else if (seas_num==12){
      season_months <- c(12)
      print("Month: Dec")
      # season <- "l) Dec" # 12-month plot
      season <- "(d) Dec"# 4-month plot
      sea <- "Dec"
    }
  }
  
  monthvec <- rep(1:12, 21)
  
  
  
  # Calculate vulnerability ------------------------------------------------------
  
  vul <- function(dat_cont, dat_bin1, dat_bin2 = NULL, surpass, percentile1, percentile2 = NA, lags = 0, months_allyears = monthvec) { # Vulnerability analysis
    if (lags <= 0) { # add lag
      dat_cont <- dat_cont[,(dim(dat_cont)[2] - dim(fapar_list[[1]])[2] + 1):dim(dat_cont)[2] + lags ] # refine to 21 years
    } else if (lags > 0) { # add lag for all but the last time step; add NA for last time step
      dat_cont <- cbind(dat_cont[,(dim(dat_cont)[2] - dim(fapar_list[[1]])[2] + 1 + lags):dim(dat_cont)[2]], matrix(NA,nrow = dim(dat_cont)[1], ncol = lags) ) # refine to 21 years
      # (final time step - (21 years + 1) + lags : final time step) + NA*lags
    }
    if (is.null(dat_bin2)) { # if there is only one binary data set
      if (surpass){ # extreme are defined as above the treshold
        nexp_val <- lapply(locat, function(x) {dat_cont[x,which(dat_bin1[x,] <= percentile1[x])]})
        exp_val <- lapply(locat, function(x) {dat_cont[x,which(dat_bin1[x,] > percentile1[x])]})
        vul <- sapply(1:length(locat), function(x) {mean(nexp_val[[x]],na.rm=T) - mean(exp_val[[x]],na.rm=T)})
        nexp_months <- lapply(locat, function(x) {months_allyears[which(dat_bin1[x,] <= percentile1[x])]} )
        exp_months <- lapply(locat, function(x) {months_allyears[which(dat_bin1[x,] > percentile1[x])]} )
        return(list(nexp_val, exp_val, vul, nexp_months, exp_months))
      } else if (!surpass){ # extreme are defined as below the treshold
        nexp_val <- lapply(locat, function(x) {dat_cont[x,which(dat_bin1[x,] >= percentile1[x])]})
        exp_val <- lapply(locat, function(x) {dat_cont[x,which(dat_bin1[x,] < percentile1[x])]})
        vul <- sapply(1:length(locat), function(x) {mean(nexp_val[[x]],na.rm=T) - mean(exp_val[[x]],na.rm=T)})
        nexp_months <- lapply(locat, function(x) {months_allyears[which(dat_bin1[x,] >= percentile1[x])]} )
        exp_months <- lapply(locat, function(x) {months_allyears[which(dat_bin1[x,] < percentile1[x])]} )
        return(list(nexp_val, exp_val, vul, nexp_months, exp_months))
      }
    } else { # multivariate case: temperature needs to be first, soil moisture second
      nexp_val <- lapply(locat, function(x) {dat_cont[x,which(dat_bin1[x,] <= percentile1[x] & dat_bin2[x,] >= percentile2[x])] })
      exp_val <- lapply(locat, function(x) {dat_cont[x,which(dat_bin1[x,] > percentile1[x] & dat_bin2[x,] < percentile2[x])] })
      vul <- sapply(1:length(locat), function(x) {mean(nexp_val[[x]],na.rm=T) - mean(exp_val[[x]],na.rm=T)})
      return(list(nexp_val, exp_val, vul ))
    }
  }
  
  # fapar under extreme temperature conditions
  vul_temp <- vul(dat_cont = fapar_list[[params$ind]], dat_bin1 = temp_list[[params$ind]], surpass = T, percentile1 = percentiles[[params$ind]][params$perc,], lags = params$time_lag_dri) 
  
  # fapar under extreme soil moisture conditions
  vul_sm <- vul(dat_cont = fapar_list[[params$ind]], dat_bin1 = sm_list[[params$ind]], surpass = F, percentile1 = percentiles[[params$ind + 5]][params$perc,], lags = params$time_lag_dri)
  
  # temperature during extreme fapar values
  imp_vul_temp <- vul(dat_cont = temp_list[[params$ind + 5]], dat_bin1 = fapar_list[[params$ind]], surpass = F, percentile1 = percentiles[[params$ind + 10]][params$perc,], lags = params$time_lag_imp)
  
  # Soil moisture during extreme fapar values
  imp_vul_sm <- vul(dat_cont = sm_list[[params$ind + 5]], dat_bin1 = fapar_list[[params$ind]], surpass = F, percentile1 = percentiles[[params$ind + 10]][params$perc,], lags = params$time_lag_imp)
  

  pick_season <- function(vul_type, season){
    nexp_val <- lapply(1:length(locat), function(x) vul_type[[1]][[x]][which(vul_type[[4]][[x]] %in% season)] )
    exp_val <- lapply(1:length(locat), function(x) vul_type[[2]][[x]][which(vul_type[[5]][[x]] %in% season)] )
    vul <- sapply(1:length(locat), function(x) {mean(nexp_val[[x]],na.rm=T) - mean(exp_val[[x]],na.rm=T)})
    return(list(nexp_val, exp_val, vul))
  }
  
  
  # run only 1 case
  vul_temp <- pick_season(vul_type = vul_temp, season = season_months)
  vul_sm <- pick_season(vul_type = vul_sm, season = season_months)
  imp_vul_temp <- pick_season(vul_type = imp_vul_temp, season = season_months)
  imp_vul_sm <- pick_season(vul_type = imp_vul_sm, season = season_months)
  

    
  # Bivariate map --------------------------------------------------

  coord <- coordinates(sm_monthly_brick)
  
  vul_temp_large <- rep(NA,dim(coord)[1]);vul_sm_large <- rep(NA,dim(coord)[1]);imp_vul_temp_large <- rep(NA,dim(coord)[1]);imp_vul_sm_large <- rep(NA,dim(coord)[1])
  vul_temp_large[locat] <- vul_temp[[3]];vul_sm_large[locat] <- vul_sm[[3]];imp_vul_temp_large[locat] <- imp_vul_temp[[3]];imp_vul_sm_large[locat] <- imp_vul_sm[[3]]
  vul_temp_ras <- rasterFromXYZ(cbind(coord,vul_temp_large));vul_sm_ras <- rasterFromXYZ(cbind(coord,vul_sm_large));imp_vul_temp_ras <- rasterFromXYZ(cbind(coord,imp_vul_temp_large));imp_vul_sm_ras <- rasterFromXYZ(cbind(coord,imp_vul_sm_large))
  
  
   border_crop <- crop(border,extent(sm_monthly_brick))
   clipExt <- extent(sm_monthly_brick)
   df_vul <- data.frame(vul_temp[[3]], vul_sm[[3]], Lon = coord[locat,1], Lat =coord[locat,2])
   df_imp_vul <- data.frame(imp_vul_temp[[3]], imp_vul_sm[[3]], Lon = coord[locat,1], Lat =coord[locat,2])

  
   max_imp_vul_temp <- max(df_imp_vul$imp_vul_temp..3.., na.rm=T)
   max_imp_vul_sm <- max(df_imp_vul$imp_vul_sm..3.., na.rm=T)
   map <- ggplot()+
     geom_tile(data=df_imp_vul,aes(Lon,Lat,fill=imp_vul_temp..3..,fill2=imp_vul_sm..3..))+
     scale_fill_colourplane(name = "", na.color = "black",
                            color_projection = YUV_projection, Y=0.3, oob = squish,
                             limits = c(-2, 2),
                            limits_y = c(-2, 2),
                            axis_title = "Vulnerability \n Temperature", axis_title_y = "Vulnerability \n soil moisture")+
     coord_fixed(ratio = 1)+
     geom_polygon(data=border_crop, aes(x=long,y=lat,group=group), fill="transparent", color="black", size=0.3)+
     labs(title = season)+
     theme(legend.position="none") # remove the legend
   
  if (params$seasonal){
    if (seas_num==1){
      map_spring <- map
    } else if (seas_num==2){
      map_summer <- map
    } else if (seas_num==3){
      map_autumn <- map
    } else if (seas_num==4){
      map_winter <- map
    }
  } else {
    if (seas_num==1){
      map_jan <- map
    } else if (seas_num==2){
      map_feb <- map
    } else if (seas_num==3){
      map_mar <- map
    } else if (seas_num==4){
      map_apr <- map
    } else if (seas_num==5){
      map_may <- map
    } else if (seas_num==6){
      map_jun <- map
    } else if (seas_num==7){
      map_jul <- map
    } else if (seas_num==8){
      map_aug <- map
    } else if (seas_num==9){
      map_sep <- map
    } else if (seas_num==10){
      map_oct <- map
    } else if (seas_num==11){
      map_nov <- map
    } else if (seas_num==12){
      map_dec <- map
    }
  }
  
  p_temp_all[[seas_num]] <- imp_vul_temp_ras
  p_sm_all[[seas_num]] <- imp_vul_sm_ras

}

if (params$seasonal){
ggarrange(map_spring, map_summer, map_autumn, map_winter, nrow = 2, ncol=2)
ggsave(filename="BivariateMap.pdf", width = 30, height = 20, units="cm")
} else {
  # 12 months
  ggarrange(map_jan, map_feb, map_mar, map_apr, map_may, map_jun, map_jul, map_aug, map_sep, map_oct, map_nov, map_dec, nrow = 4, ncol=3)
  ggsave(filename="BivariateMap_monthly_v1.pdf", width = 30, height = 20, units="cm")
  # 4 months subset
  ggarrange(map_mar, map_jun, map_sep, map_dec, nrow = 2, ncol=2)
  ggsave(filename="BivariateMap_monthly_v1_4months.pdf", width = 30, height = 14.5, units="cm")
  # 8 months subset
  ggarrange(map_jan, map_feb, map_apr, map_may, map_jul, map_aug, map_oct, map_nov, nrow = 4, ncol=2)
  ggsave(filename="BivariateMap_monthly_v1_8months.pdf", width = 20, height = 20, units="cm")
}


# Univariate maps ####
  

devtools::source_gist('306e4b7e69c87b1826db')

p_temp_stack <- stack(p_temp_all)

# color ramp diverging around 0 to fixed value (symmetric)
png("Map_temperature_monthly.png", 30,20, units="cm", res=1000)
levelplot(p_temp_stack, margin=F, main="Vulnerability for temperature during extreme fapar values", layout=c(3,4), par.settings=RdBuTheme(),  at=seq(-2, 2, length=50), len=100)+
layer(sp.polygons(border,col='black'))
dev.off()

p_sm_stack <- stack(p_sm_all)

# color ramp diverging around 0 to fixed value (symmetric)
png("Map_soil_moisture_monthly.png", 30,20, units="cm", res=1000)
levelplot(p_sm_stack, margin=F, main="Vulnerability for soil moisture during extreme fapar values", layout=c(3,4), par.settings=RdBuTheme(),  at=seq(-2, 2, length=50), len=100)+
layer(sp.polygons(border,col='black'))
dev.off()
```