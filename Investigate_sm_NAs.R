# Investigate soil moisture NA values

library(tidyverse)
library(pbapply)
library(raster)
library(viridis)
library(RColorBrewer)
library(rgdal)
library(rasterVis)
library(rworldxtra)

path_data <- message("insert path here")
path_workspaces <- message("insert path here")
path_data <- "D:/Local/Data/"
# path_workspaces <- "C:/Users/vogelh/ownCloud/Promotion/Impact_analysis/Code/"
# path_workspaces <- "C:/Users/vogel/boxup/Promotion/Impact_analysis/Code/"


# Load soil moisture and day/night flag (because this variable has NaN values easily visible) 
# See e.g. Kidd 2018
sm_monthly_nc <- brick(paste0(path_data,"ESA_CCI/2_daily_images/combined/Yearly/sm79_19_monthly.nc"),varname="sm") # created with cdo
dnflag_monthly_nc <- brick(paste0(path_data,"ESA_CCI/2_daily_images/combined/Yearly/sm79_19_monthly.nc"),varname="dnflag") # Day / Night Flag
border <- readOGR(paste0(path_data,'GIS_data/ne_50m_admin_0_countries/ne_50m_admin_0_countries.shp'))


# extract only land values ####
# Preprocessing
fapar_scene <- raster(paste0(path_data,"./fAPAR/fAPAR_extracted/c_gls_FAPAR_199901100000_GLOBE_VGT_V2.0.2/19990110/c_gls_FAPAR-FAPAR_199901100000_CUSTOM_VGT_V2.0.2.tiff"))
sm_scene <- raster(paste0(path_data,"./ESA_CCI/2_daily_images/combined/1999/ESACCI-SOILMOISTURE-L3S-SSMV-COMBINED-19990101000000-fv04.7.nc"),varname="sm")
sm_crop <- crop(sm_scene,extent(fapar_scene))
# create Köppen-Geiger map
source('./Code/Koeppen_Geiger.R') # This file is obtained from http://koeppen-geiger.vu-wien.ac.at/present.htm
# Crop Köppen-Geiger map to Mediterranean area
Koeppen <- crop(Koeppen,sm_crop)
# Resample Köppen-Geiger map to resolution of ERA5 data
set.seed(40) # resample gives different result every time
Koeppen <- resample(Koeppen,sm_crop,method="ngb") # nearest neighbor is appropriate for categorical variables
# Apparently, it's not possible to give multiple values to the mask command.
# Workaround: assign both values 12 and 13 to a non-existing value (e.g. 1)
Koeppen[Koeppen@data@values==12] <- 1
Koeppen[Koeppen@data@values==13] <- 1
locat <- which(Koeppen@data@values==1)
locat_land <- which(Koeppen@data@values!=32)



# Assess monthly series ####
############################

# How many pixels are NA at a given time step ####
values_med <- lapply( 1:492, function(x) values(sm_monthly_nc[[x]])[locat] )
NAs_med <- sapply( 1:492, function(x) summary(values_med[[x]])[7] ) # Number of NAs for each month
summary(NAs_med/length(locat))
pdf(file="./Output/Soil_moisture_availability/Time_series_sm_na_monthly.pdf", width=12)
  plot(NAs_med/length(locat),xaxt='n', main="Fraction of mediterranean pixels, which \n are NA at a monthly time step for each year 1979 - 2019",
       xlab="Time", ylab="Percentage of pixels", las=2, font=2, font.lab=2)
  allyears <- 1979:2019
  placements <- c(1,(cumsum(rep(12,40))+1))
  axis(1,at=placements,labels=allyears,font=2)
dev.off()


# Extract the values
ts_sm <- pbsapply(locat, function(x) raster::extract(sm_monthly_nc,x) )
NA_per_pixel <- pbsapply(1:length(locat), function(x) sum(is.na(ts_sm[,x])) ) # 1979 - 2019
NA_per_pixel99 <- pbsapply(1:length(locat), function(x) sum(is.na(ts_sm[241:492,x])) ) # 1999 - 2019

sum(NA_per_pixel99<=60) # 2425 pixels miss less than 60 entries, i.e. 5 years of data
summary(NA_per_pixel99[NA_per_pixel99<=60]) # of those pixels with less than 60 misses, the median number of NAs is 7 months
NA_always_pix <- which(NA_per_pixel==492)
locat_red <- locat[-NA_always_pix] # exlude pixel which are always NA


# Plot on map
pdf(file="./Output/Soil_moisture_availability/Map_sm_avaible_monthly_count_99_19.pdf", width=13.8)
par(oma=c(0,0,0,3))
plot((252-na_ras)/252*100, col=(brewer.pal(9, "Oranges"))[3:8], zlim=c(0,100), main="", las=1, font=2, cex.axis=1.3,
     colNA="grey90", axis.args=list(font=2, at=c(0,20,40,60,80,100), cex.axis=2))
plot(excl_pix, add=T, pch=16, col="gray10", cex=0.5)
plot(border, add=T)
dev.off()


locat_final <- locat[NA_per_pixel99 <= 60]
save(locat_final, file=paste0(path_workspaces,"locations_final.RData"))
locat_no_NA <- locat[NA_per_pixel99 == 0] # all pixels without NAs in 1999-2019
save(locat_no_NA, file=paste0(path_workspaces,"locations_no_NAs.RData"))
