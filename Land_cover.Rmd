---
title: "Land_cover"
author: "Johannes Vogel"
date: "31 7 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
```

```{r Load data, include = F}
# Load data ---------------------------------------------------------------
library(raster)
library(ncdf4)
library(tictoc)
library(tidyverse)

path_data <- message("insert path here")
path_workspaces <- message("insert path here")

# Land cover of 2018
lc <- brick(paste0(path_data,"GIS_data/ESA_CCI_LC/dataset-satellite-land-cover-b34a4b60-efd3-464c-832a-397ce11e4d6b/C3S-LC-L4-LCCS-Map-300m-P1Y-2018-v2.1.1.nc", varname="lccs_class"))
load(paste0(path_workspaces,file="Regional_indices.RData"))
# Reduce subset by excluding pixels, where one of the variables has no entries and soil moisture data is scarce
load(file=paste0(path_workspaces,"locations_final.RData")) # Points with less than 60 data gaps according to Investigate_sm_NAs.r
sm_na <- sapply(locat, function(x) all(is.na(sm_list[[1]][x,])) )
temp_na <- sapply(locat, function(x) all(is.na(temp_list[[1]][x,])) )
fapar_na <- sapply(locat, function(x) all(is.na(fapar_list[[1]][x,])) )
locat_na <- locat[(!sm_na & !temp_na & !fapar_na)] # entries numbered by whole data set
locat <- intersect(locat_na,locat_final) # Exclude pixels which are always NA or miss more than 60 soil moisture data entries
# locat <- intersect(locat_na,locat_no_NA) # Exclude pixels which have any missing soil moisture data
save(locat, file = paste0(path_workspaces,"locat.RData"))
load(file=paste0(path_workspaces,"locat.RData"))

# Preprocessing ####
fapar_scene <- raster(paste0(path_data,"fAPAR/fAPAR_extracted/c_gls_FAPAR_199901100000_GLOBE_VGT_V2.0.2/19990110/c_gls_FAPAR-FAPAR_199901100000_CUSTOM_VGT_V2.0.2.tiff"))
sm_scene <- raster(paste0(path_data,"ESA_CCI/2_daily_images/combined/1999/ESACCI-SOILMOISTURE-L3S-SSMV-COMBINED-19990101000000-fv04.7.nc"),varname="sm")
sm_crop <- crop(sm_scene,extent(fapar_scene))
```

```{r Visualize land cover, fig.height=10, fig.width=10, include=F}
# Visualize land cover ----------------------------------------------------

# lc_crop <- crop(lc,extent(fapar_scene))
# set.seed(10)
# lc_res <- resample(lc_crop, sm_crop, method="ngb")
# writeRaster(lc_res, file=paste0(path_data,"GIS_data/ESA_CCI_LC/lc_cropped.tif"))
lc_res <- raster(paste0(path_data,"GIS_data/ESA_CCI_LC/lc_cropped.tif"))
plot(lc_res)
barplot(table(values(lc_res)),horiz=T, las=2)
```

```{r Assign vulnerability to land cover classes, fig.height=10, fig.width=10}
#  Assign vulnerability to land cover classes -----------------------------

lc_med_val <- raster::extract(lc_res,locat)
barplot(table(lc_med_val), horiz=T, las=2, main= "Number of Pixels per land cover")
lcs <- vector("character",length(locat))
landcovers_chr <- c("Cropland, rainfed", "Cropland, rainfed, herbaceous cover", "Cropland, rainfed, tree or shrub cover",
                    "Cropland, irrigated or postflooding", "Mosaic cropland (>50%) / natural vegetation (tree, shrub, herbaceous cover) (<50%)",
                    "Mosaic natural vegetation (tree, shrub, herbaceous cover) (>50%) / cropland (<50%)", "Tree cover, broadleaved, deciduous, closed to open (>15%)",
                    "Tree cover, broadleaved, deciduous, open (15-40%)", "Tree cover, needleleaved, evergreen, closed to open (>15%)",
                    "Mosaic tree and shrub (>50%) / herbaceous cover (<50%)", "Shrubland", "Grassland",
                    "Sparse vegetation (tree, shrub, herbaceous cover) (<15%)", "Sparse herbaceous cover (<15%)",
                    "Urban areas", "Bare areas", "Water bodies")
message("See ESA.2017, Appendix 1")

k <- 1
for (i in sort(unique(lc_med_val))){
  lcs[lc_med_val == i] <- landcovers_chr[k]
  k <- k + 1
}

lcs_aggr <- lcs
lcs_aggr[lcs_aggr == "Cropland, rainfed"] <- "Crops (rainfed)"
lcs_aggr[lcs_aggr == "Cropland, rainfed, herbaceous cover"] <- "Crops (rainfed)"
lcs_aggr[lcs_aggr == "Cropland, rainfed, tree or shrub cover"] <- "Crops (rainfed)"
lcs_aggr[lcs_aggr == "Cropland, irrigated or postflooding"] <- "Crops (irrigated)"
lcs_aggr[lcs_aggr == "Mosaic cropland (>50%) / natural vegetation (tree, shrub, herbaceous cover) (<50%)"] <- "Mixed"
lcs_aggr[lcs_aggr == "Mosaic natural vegetation (tree, shrub, herbaceous cover) (>50%) / cropland (<50%)"] <- "Mixed"
lcs_aggr[lcs_aggr == "Mosaic tree and shrub (>50%) / herbaceous cover (<50%)"] <- "Mixed"
lcs_aggr[lcs_aggr == "Tree cover, broadleaved, deciduous, closed to open (>15%)"] <- "Forest (broadleaved)"
lcs_aggr[lcs_aggr == "Tree cover, broadleaved, deciduous, open (15-40%)"] <- "Forest (broadleaved)"
lcs_aggr[lcs_aggr == "Tree cover, needleleaved, evergreen, closed to open (>15%)"] <- "Forest (needleleaved)"
lcs_aggr[lcs_aggr == "Sparse vegetation (tree, shrub, herbaceous cover) (<15%)"] <- "Sparse vegetation"
lcs_aggr[lcs_aggr == "Sparse herbaceous cover (<15%)"] <- "Sparse vegetation"
lcs_aggr[lcs_aggr == "Bare areas"] <- "Sparse vegetation"

par(oma=c(2,15,2,1))
barplot(table(lcs_aggr), horiz=T, las=2, main= "Number of Pixels per land cover")
barplot(sort(table(lcs_aggr)), horiz=T, las=2, main= "Number of Pixels per land cover")
save(lcs, lcs_aggr, file=paste0(path_workspaces,"Landcovers.RData"))
```

```{r Investigate pixels with land cover change}
lc_change <- brick(paste0(path_data,"GIS_data/ESA_CCI_LC/dataset-satellite-land-cover-b34a4b60-efd3-464c-832a-397ce11e4d6b/C3S-LC-L4-LCCS-Map-300m-P1Y-2018-v2.1.1.nc", varname="change_count"))
lc_change_crop <- crop(lc_change,extent(fapar_scene))
set.seed(10)
lc_change_res <- resample(lc_change_crop, sm_crop, method="ngb")
plot(lc_change_crop)
plot(lc_change_res)

barplot(table(values(lc_change_res)),horiz=T, las=2)
change_val<- values(lc_change_res, format = "matrix")
which(change_val == 1)
```

```{r Land cover from 1999}
lc99 <- brick(paste0(path_data,"GIS_data/ESA_CCI_LC/ESACCI-LC-L4-LCCS-Map-300m-P1Y-1999-v2.0.7b.nc", varname="lccs_class"))
plot(lc99)

# lc99_crop <- crop(lc99[[1]],extent(fapar_scene))
# set.seed(10)
# lc99_res <- resample(lc99_crop, sm_crop, method="ngb")
# writeRaster(lc99_res, file="D:/Local/Data/GIS_data/ESA_CCI_LC/lc99_cropped.tif", overwrite=T)
lc99_res <- raster(paste0(path_data,"GIS_data/ESA_CCI_LC/lc99_cropped.tif"))

# plot(lc_crop)
plot(lc99_res)
# table(values(lc_crop))
# table(values(lc_res))
# barplot(table(values(lc_crop)),horiz=T)
barplot(table(values(lc99_res)),horiz=T, las=2)
```

```{r Assign vulnerability to land cover classes for 1999, fig.height=10, fig.width=10}
#  Assign vulnerability to land cover classes -----------------------------

lc99_med_val <- raster::extract(lc99_res,locat)
barplot(table(lc99_med_val), horiz=T, las=2, main= "Number of Pixels per land cover")
table(lc99_med_val)
table(lc_med_val)
message("somehow all classes above 120 get 256 subtracted. The reason for this is unknown.")
lc99_med_val[lc99_med_val<0] <- lc99_med_val[lc99_med_val<0]+256 # correct this
values(lc99_res)[values(lc99_res)<0] <- values(lc99_res)[values(lc99_res)<0]+256 # correct this

lcs99 <- vector("character",length(locat))
landcovers_chr <- c("Cropland, rainfed", "Cropland, rainfed, herbaceous cover", "Cropland, rainfed, tree or shrub cover",
                    "Cropland, irrigated or postflooding", "Mosaic cropland (>50%) / natural vegetation (tree, shrub, herbaceous cover) (<50%)",
                    "Mosaic natural vegetation (tree, shrub, herbaceous cover) (>50%) / cropland (<50%)", "Tree cover, broadleaved, deciduous, closed to open (>15%)",
                    "Tree cover, broadleaved, deciduous, open (15-40%)", "Tree cover, needleleaved, evergreen, closed to open (>15%)",
                    "Mosaic tree and shrub (>50%) / herbaceous cover (<50%)", "Shrubland", "Grassland",
                    "Sparse vegetation (tree, shrub, herbaceous cover) (<15%)", "Sparse herbaceous cover (<15%)",
                    "Urban areas", "Bare areas", "Water bodies")
message("See ESA.2017, Appendix 1")

k <- 1
for (i in sort(unique(lc99_med_val))){
  lcs99[lc99_med_val == i] <- landcovers_chr[k]
  k <- k + 1
}

lcs99_aggr <- lcs99
lcs99_aggr[lcs99_aggr == "Cropland, rainfed"] <- "Crops (rainfed)"
lcs99_aggr[lcs99_aggr == "Cropland, rainfed, herbaceous cover"] <- "Crops (rainfed)"
lcs99_aggr[lcs99_aggr == "Cropland, rainfed, tree or shrub cover"] <- "Crops (rainfed)"
lcs99_aggr[lcs99_aggr == "Cropland, irrigated or postflooding"] <- "Crops (irrigated)"
lcs99_aggr[lcs99_aggr == "Mosaic cropland (>50%) / natural vegetation (tree, shrub, herbaceous cover) (<50%)"] <- "Mixed"
lcs99_aggr[lcs99_aggr == "Mosaic natural vegetation (tree, shrub, herbaceous cover) (>50%) / cropland (<50%)"] <- "Mixed"
lcs99_aggr[lcs99_aggr == "Mosaic tree and shrub (>50%) / herbaceous cover (<50%)"] <- "Mixed"
lcs99_aggr[lcs99_aggr == "Tree cover, broadleaved, deciduous, closed to open (>15%)"] <- "Forest (broadleaved)"
lcs99_aggr[lcs99_aggr == "Tree cover, broadleaved, deciduous, open (15-40%)"] <- "Forest (broadleaved)"
lcs99_aggr[lcs99_aggr == "Tree cover, needleleaved, evergreen, closed to open (>15%)"] <- "Forest (needleleaved)"
lcs99_aggr[lcs99_aggr == "Sparse vegetation (tree, shrub, herbaceous cover) (<15%)"] <- "Sparse vegetation"
lcs99_aggr[lcs99_aggr == "Sparse herbaceous cover (<15%)"] <- "Sparse vegetation"
lcs99_aggr[lcs99_aggr == "Bare areas"] <- "Sparse vegetation"

table(lcs99)
table(lcs)
table(lcs99_aggr)
table(lcs_aggr)

sum(lcs99_aggr == lcs_aggr)
sum(lcs99_aggr != lcs_aggr)
sum(lcs99 == lcs)
sum(lcs99 != lcs)

plot(lc99_res)
plot(lc_res)

locat_red <- locat[lcs99_aggr == lcs_aggr]
lcs_red <- lcs[lcs99_aggr == lcs_aggr]
reg_id_red <- reg_id[lcs99_aggr == lcs_aggr]
lcs_aggr_red <- lcs_aggr[lcs99_aggr == lcs_aggr]

par(oma=c(2,15,2,1))
barplot(table(lcs99_aggr), horiz=T, las=2, main= "Number of Pixels per land cover")
barplot(sort(table(lcs99_aggr)), horiz=T, las=2, main= "Number of Pixels per land cover")
table(lcs99_aggr)/table(lcs_aggr)
save(lcs99, lcs99_aggr, file=paste0(path_workspaces,"Landcovers99.RData"))
save(locat_red, lcs_red, reg_id_red, lcs_aggr_red, file=paste0(path_data,"locat_red.RData"))
```

