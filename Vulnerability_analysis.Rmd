---
title: "Vulnerability_analysis"
author: "Johannes Vogel"
date: "23 6 2020"
output: html_document
params:
  perc: 2 # which of the three percentiles to pick (0.05, 0.10, 0.15)
  ind: 4 # "4" signifies deseasonalised and z-scored with 3 months moving window
  time_lag_dri: 0 # time lag of driver
  time_lag_imp: 0 # time lag of impact
  vsw: FALSE # T: pick ESA CCI soil moisture, F: pick ERA5 Land soil moisture
  mv3_driver_only: TRUE # T: moving window only for driver, not impact, F: moving window for both
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
library(pbapply)
library(raster)
library(viridis)
library(RColorBrewer)
library(rgdal)
require(colorplaner)
require(ggplot2)
library(cowplot)
library(tidyverse)
library(rasterVis)
library(scales)
```

```{r Load data, include = F}
path_data <- message("insert path here")
path_workspaces <- message("insert path here")
load(file=paste0(path_workspaces,"Preprocessed_data.RData")) # Preprocessed data from Preprocessing.r
border <- readOGR(paste0(path_data,'GIS_data/ne_50m_admin_0_countries/ne_50m_admin_0_countries.shp')) # from https://www.naturalearthdata.com/downloads/50m-cultural-vectors/50m-admin-0-countries-2/
load(file=paste0(path_workspaces,"Regional_indices.RData")) # from Regional_comparisons.r
load(file = paste0(path_workspaces,"Landcovers.RData")) # from Land_cover.Rmd
# Reduced set where pixels with land cover change are excluded
load(file=paste0(path_workspaces,"locat_red.RData")) # from Land_cover.Rmd
locat <- locat_red
lcs <- lcs_red
reg_id <- reg_id_red
lcs_aggr <- lcs_aggr_red
locat <- locat[lcs_aggr_red!="Water bodies" & lcs_aggr_red!="Urban areas"] # exclude Water bodies and Urban areas
lcs <- lcs[lcs_aggr_red!="Water bodies" & lcs_aggr_red!="Urban areas"]
reg_id <- reg_id[lcs_aggr_red!="Water bodies" & lcs_aggr_red!="Urban areas"]
lcs_aggr <- lcs_aggr[lcs_aggr_red!="Water bodies" & lcs_aggr_red!="Urban areas"]

if (params$vsw){
  sm_list <- vsw_list # change from ESA CCI soil moisture data to ERA5 Land
  percentiles[6:10] <- percentiles[11:15]
}

if (params$mv3_driver_only){
  fapar_list[[4]] <- fapar_list[[2]] # for easy implementation: only apply moving window to drivers, not to impact
  names(fapar_list)[4] <- "fapar_des_z"
  percentiles[["percentiles_fapar_des_z_mv3"]] <- percentiles[["percentiles_fapar_des_z"]]
  # names(percentiles)[14] <- "percentiles_fapar_des_z"
  names(percentiles)[19] <- "percentiles_fapar_des_z"
}
```

```{r Vulnerability analysis, eval=T}

monthvec <- rep(1:12, 21) 

vul <- function(dat_cont, dat_bin1, dat_bin2 = NULL, surpass, percentile1, percentile2 = NA, lags = 0, months_allyears = monthvec) { # Vulnerability analysis
  if (lags <= 0) { # add lag
    dat_cont <- dat_cont[,(dim(dat_cont)[2] - dim(fapar_list[[1]])[2] + 1):dim(dat_cont)[2] + lags ] # refine to 21 years
  } else if (lags > 0) { # add lag for all but the last time step; add NA for last time step
    dat_cont <- cbind(dat_cont[,(dim(dat_cont)[2] - dim(fapar_list[[1]])[2] + 1 + lags):dim(dat_cont)[2]], matrix(NA,nrow = dim(dat_cont)[1], ncol = lags) ) # refine to 21 years
    # (final time step - (21 years + 1) + lags : final time step) + NA*lags
  }
  if (is.null(dat_bin2)) { # if there is only one binary data set
    if (surpass){ # extreme are defined as above the treshold
      nexp_val <- lapply(locat, function(x) {dat_cont[x,which(dat_bin1[x,] <= percentile1[x])]})
      exp_val <- lapply(locat, function(x) {dat_cont[x,which(dat_bin1[x,] > percentile1[x])]})
      vul <- sapply(1:length(locat), function(x) {mean(nexp_val[[x]],na.rm=T) - mean(exp_val[[x]],na.rm=T)})
      nexp_months <- lapply(locat, function(x) {months_allyears[which(dat_bin1[x,] <= percentile1[x])]} )
      exp_months <- lapply(locat, function(x) {months_allyears[which(dat_bin1[x,] > percentile1[x])]} )
      return(list(nexp_val, exp_val, vul, nexp_months, exp_months))
    } else if (!surpass){ # extreme are defined as below the treshold
      nexp_val <- lapply(locat, function(x) {dat_cont[x,which(dat_bin1[x,] >= percentile1[x])]})
      exp_val <- lapply(locat, function(x) {dat_cont[x,which(dat_bin1[x,] < percentile1[x])]})
      vul <- sapply(1:length(locat), function(x) {mean(nexp_val[[x]],na.rm=T) - mean(exp_val[[x]],na.rm=T)})
      nexp_months <- lapply(locat, function(x) {months_allyears[which(dat_bin1[x,] >= percentile1[x])]} )
      exp_months <- lapply(locat, function(x) {months_allyears[which(dat_bin1[x,] < percentile1[x])]} )
      return(list(nexp_val, exp_val, vul, nexp_months, exp_months))
    }
  } else { # multivariate case: temperature needs to be first, soil moisture second
    nexp_val <- lapply(locat, function(x) {dat_cont[x,which(dat_bin1[x,] <= percentile1[x] & dat_bin2[x,] >= percentile2[x])] })
    exp_val <- lapply(locat, function(x) {dat_cont[x,which(dat_bin1[x,] > percentile1[x] & dat_bin2[x,] < percentile2[x])] })
    vul <- sapply(1:length(locat), function(x) {mean(nexp_val[[x]],na.rm=T) - mean(exp_val[[x]],na.rm=T)})
    return(list(nexp_val, exp_val, vul ))
  }
}

# fapar under extreme temperature conditions
vul_temp <- vul(dat_cont = fapar_list[[params$ind]], dat_bin1 = temp_list[[params$ind]], surpass = T, percentile1 = percentiles[[params$ind]][params$perc,], lags = params$time_lag_dri) 

# fapar under extreme soil moisture conditions
vul_sm <- vul(dat_cont = fapar_list[[params$ind]], dat_bin1 = sm_list[[params$ind]], surpass = F, percentile1 = percentiles[[params$ind + 5]][params$perc,], lags = params$time_lag_dri)

# temperature during extreme fapar values
imp_vul_temp <- vul(dat_cont = temp_list[[params$ind + 5]], dat_bin1 = fapar_list[[params$ind]], surpass = F, percentile1 = percentiles[[params$ind + 15]][params$perc,], lags = params$time_lag_imp)

# Soil moisture during extreme fapar values
imp_vul_sm <- vul(dat_cont = sm_list[[params$ind + 5]], dat_bin1 = fapar_list[[params$ind]], surpass = F, percentile1 = percentiles[[params$ind + 15]][params$perc,], lags = params$time_lag_imp)

# save(vul_temp, vul_sm, vul_temp_sm, imp_vul_temp, imp_vul_sm, file = "./Workspaces/Vulnerability.RData")
save(vul_temp, vul_sm, imp_vul_temp, imp_vul_sm, file = paste0(path_workspaces,"Vulnerability.RData"))
``` 

```{r Schematic plot, eval= F}

# Special vulnerability function, which also save the values of the binary variable for the plot
vul_spec <- function(dat_cont, dat_bin1, dat_bin2 = NULL, surpass, percentile1, percentile2 = NA, lags = 0, months_allyears = monthvec) { # Vulnerability analysis
  if (lags <= 0) { # add lag
    dat_cont <- dat_cont[,(dim(dat_cont)[2] - dim(fapar_list[[1]])[2] + 1):dim(dat_cont)[2] + lags ] # refine to 21 years
  } else if (lags > 0) { # add lag for all but the last time step; add NA for last time step
    dat_cont <- cbind(dat_cont[,(dim(dat_cont)[2] - dim(fapar_list[[1]])[2] + 1 + lags):dim(dat_cont)[2]], matrix(NA,nrow = dim(dat_cont)[1], ncol = lags) ) # refine to 21 years
    # (final time step - (21 years + 1) + lags : final time step) + NA*lags
  }
  if (is.null(dat_bin2)) { # if there is only one binary data set
    if (surpass){ # extreme are defined as above the treshold
      nexp_val <- lapply(locat, function(x) {dat_cont[x,which(dat_bin1[x,] <= percentile1[x])]})
      exp_val <- lapply(locat, function(x) {dat_cont[x,which(dat_bin1[x,] > percentile1[x])]})
      vul <- sapply(1:length(locat), function(x) {mean(nexp_val[[x]],na.rm=T) - mean(exp_val[[x]],na.rm=T)})
      nexp_months <- lapply(locat, function(x) {months_allyears[which(dat_bin1[x,] <= percentile1[x])]} )
      exp_months <- lapply(locat, function(x) {months_allyears[which(dat_bin1[x,] > percentile1[x])]} )
      return(list(nexp_val, exp_val, vul, nexp_months, exp_months))
    } else if (!surpass){ # extreme are defined as below the treshold
      nexp_val <- lapply(locat, function(x) {dat_cont[x,which(dat_bin1[x,] >= percentile1[x])]})
      exp_val <- lapply(locat, function(x) {dat_cont[x,which(dat_bin1[x,] < percentile1[x])]})
      vul <- sapply(1:length(locat), function(x) {mean(nexp_val[[x]],na.rm=T) - mean(exp_val[[x]],na.rm=T)})
      nexp_months <- lapply(locat, function(x) {months_allyears[which(dat_bin1[x,] >= percentile1[x])]} )
      exp_months <- lapply(locat, function(x) {months_allyears[which(dat_bin1[x,] < percentile1[x])]} )
      nexp_val_bin <- lapply(locat, function(x) {dat_bin1[x,which(dat_bin1[x,] >= percentile1[x])]})
      exp_val_bin <- lapply(locat, function(x) {dat_bin1[x,which(dat_bin1[x,] < percentile1[x])]})
      return(list(nexp_val, exp_val, vul, nexp_months, exp_months, nexp_val_bin, exp_val_bin))
    }
  } 
}
imp_vul_temp_spec <- vul_spec(dat_cont = temp_list[[params$ind + 5]], dat_bin1 = fapar_list[[params$ind]], surpass = F, percentile1 = percentiles[[params$ind + 15]][params$perc,], lags = params$time_lag_imp)
imp_vul_sm_spec <- vul_spec(dat_cont = sm_list[[params$ind + 5]], dat_bin1 = fapar_list[[params$ind]], surpass = F, percentile1 = percentiles[[params$ind + 15]][params$perc,], lags = params$time_lag_imp)

pick_season_spec <- function(vul_type, season){
  nexp_val <- lapply(1:length(locat), function(x) vul_type[[1]][[x]][which(vul_type[[4]][[x]] %in% season)] )
  exp_val <- lapply(1:length(locat), function(x) vul_type[[2]][[x]][which(vul_type[[5]][[x]] %in% season)] )
  vul <- sapply(1:length(locat), function(x) {mean(nexp_val[[x]],na.rm=T) - mean(exp_val[[x]],na.rm=T)})
  nexp_val_bin <- lapply(1:length(locat), function(x) vul_type[[6]][[x]][which(vul_type[[4]][[x]] %in% season)] )
  exp_val_bin <- lapply(1:length(locat), function(x) vul_type[[7]][[x]][which(vul_type[[5]][[x]] %in% season)] )
  return(list(nexp_val, exp_val, vul, nexp_val_bin, exp_val_bin))
}
jul <- 7
imp_vul_temp_Jul_spec <- pick_season_spec(vul_type = imp_vul_temp_spec, season = jul)
imp_vul_sm_Jul_spec <- pick_season_spec(vul_type = imp_vul_sm_spec, season = jul)


# k <- 1178 # Exemplary pixel
k <- 1175 # Revision: Exemplary pixel
pdf(file="./Output/Scheme_vulnerability_analysis.pdf", width = 15, height = 7 )
par(mfrow=c(1,2), oma=c(0,3,1,0))
plot(imp_vul_temp_Jul_spec[[4]][[k]],imp_vul_temp_Jul_spec[[1]][[k]], xlab="", ylab="", las=1, font=2,cex=1, xlim=c(-2,2),ylim=c(-2,1.5))
points(imp_vul_temp_Jul_spec[[5]][[k]],imp_vul_temp_Jul_spec[[2]][[k]], xlab="", ylab="", las=1, font=2,cex=1)
mtext(side=1,text="FAPAR (deseasonalised and standardised)",font=2,line=2,cex=1.2)
mtext(side=1,text="sys",font=2,line=3.5,cex=1.8)
mtext(side=2,text="Temperature (deseasonalised and standardised)",font=2,line=3,cex=1.2)
mtext(side=2,text="env",font=2,line=4,cex=1.8)
mtext(side=3,text=expression("10"^th*" percentile"),font=2,line=0,adj=0.09,cex=1.8,col="orange")

abline(v=percentiles[[params$ind + 15]][params$perc,locat[k]], col='orange', lwd=2)
lines(x=c(-10,percentiles[[params$ind + 15]][params$perc,locat[k]]) , y=rep(mean(imp_vul_temp_Jul_spec[[2]][[k]],na.rm=T),2), lwd=2, col="blue")
lines(x=c(percentiles[[params$ind + 15]][params$perc,locat[k]],10) , y=rep(mean(imp_vul_temp_Jul_spec[[1]][[k]],na.rm=T),2), lwd=2, col="blue")
lines(x=rep(percentiles[[params$ind + 15]][params$perc,locat[k]],2), y=c(mean(imp_vul_temp_Jul_spec[[1]][[k]],na.rm=T),mean(imp_vul_temp_Jul_spec[[2]][[k]],na.rm=T)), col='red', lwd=4)
text(x=percentiles[[params$ind + 15]][params$perc,locat[k]]+0.4, y=mean(imp_vul_temp_Jul_spec[[1]][[k]],na.rm=T)-imp_vul_temp_Jul_spec[[3]][k]/2, expression("V"[E]), font=2,adj=0.8, cex=3.2, col="red")
text(x=-1.6, y=mean(imp_vul_temp_Jul_spec[[2]][[k]],na.rm=T)+0.15, expression("E"[haz]), font=2, cex=2.3, col="blue")
text(x=0.57, y=mean(imp_vul_temp_Jul_spec[[1]][[k]],na.rm=T)+0.15, expression("E"[nonhaz]), font=2, cex=2.3, col="blue")
mtext(side=1, text="nonhaz", font=2, line=-2, adj=0.68, cex=2, col="darkgrey")
mtext(side=1, text="haz", font=2, line =-2, adj=0.098, cex=2, col="darkgrey")
mtext(side=3, text="(a)", font=2, line = 0.5, cex=3, adj=-0.1)

plot(imp_vul_sm_Jul_spec[[4]][[k]],imp_vul_sm_Jul_spec[[1]][[k]], xlab="", ylab="", las=1, font=2,cex=1, xlim=c(-2,2),ylim=c(-2,1.5))
points(imp_vul_sm_Jul_spec[[5]][[k]],imp_vul_sm_Jul_spec[[2]][[k]], xlab="", ylab="", las=1, font=2,cex=1)
mtext(side=1,text="FAPAR (deseasonalised and standardised)",font=2,line=2,cex=1.2)
mtext(side=2,text="Soil moisture (deseasonalised and standardised)",font=2,line=3,cex=1.2)
mtext(side=1,text="sys",font=2,line=3.5,cex=1.8)
mtext(side=2,text="env",font=2,line=4,cex=1.8)
mtext(side=3,text=expression("10"^th*" percentile"),font=2,line=0,adj=0.09,cex=1.8,col="orange")

abline(v=percentiles[[params$ind + 15]][params$perc,locat[k]], col='orange', lwd=2)
lines(x=c(-10,percentiles[[params$ind + 15]][params$perc,locat[k]]) , y=rep(mean(imp_vul_sm_Jul_spec[[2]][[k]],na.rm=T),2), lwd=2, col="blue")
lines(x=c(percentiles[[params$ind + 15]][params$perc,locat[k]],10) , y=rep(mean(imp_vul_sm_Jul_spec[[1]][[k]],na.rm=T),2), lwd=2, col="blue")
lines(x=rep(percentiles[[params$ind + 15]][params$perc,locat[k]],2), y=c(mean(imp_vul_sm_Jul_spec[[1]][[k]],na.rm=T),mean(imp_vul_sm_Jul_spec[[2]][[k]],na.rm=T)), col='red', lwd=4)
text(x=percentiles[[params$ind + 15]][params$perc,locat[k]]+0.4, y=mean(imp_vul_sm_Jul_spec[[1]][[k]],na.rm=T)-imp_vul_sm_Jul_spec[[3]][k]/2, expression("V"[E]), font=2,adj=0.8, cex=3.2, col="red")
text(x=-1.6, y=mean(imp_vul_sm_Jul_spec[[2]][[k]],na.rm=T)+0.15, expression("E"[haz]), font=2, cex=2.3, col="blue")
text(x=0.57, y=mean(imp_vul_sm_Jul_spec[[1]][[k]],na.rm=T)+0.15, expression("E"[nonhaz]), font=2.3, cex=2, col="blue")
mtext(side=1, text="nonhaz", font=2, line=-2, adj=0.68, cex=2, col="darkgrey")
mtext(side=1, text="haz", font =2, line =-2, adj=0.098, cex=2, col="darkgrey")
mtext(side=3, text="(b)", font =2, line = 0.5, cex=3, adj=-0.1)
dev.off()
```

```{r Seasonal vulnerability analysis, eval=T}
pick_season <- function(vul_type, season){
  nexp_val <- lapply(1:length(locat), function(x) vul_type[[1]][[x]][which(vul_type[[4]][[x]] %in% season)] )
  exp_val <- lapply(1:length(locat), function(x) vul_type[[2]][[x]][which(vul_type[[5]][[x]] %in% season)] )
  vul <- sapply(1:length(locat), function(x) {mean(nexp_val[[x]],na.rm=T) - mean(exp_val[[x]],na.rm=T)})
  return(list(nexp_val, exp_val, vul))
}
```


```{r All seasons and cases}

spr <- c(3,4,5)
sum <- c(6,7,8)
aut <- c(9,10,11)
win <- c(12,1,2)
jan <- 1; feb <- 2; mar <- 3; apr <- 4; may <- 5; jun <- 6
jul <- 7; aug <- 8; sep <- 9; oct <- 10; nov <- 11; dec <- 12

# Seasons
vul_temp_spring <- pick_season(vul_type = vul_temp, season = spr)
vul_temp_summer <- pick_season(vul_type = vul_temp, season = sum)
vul_temp_autumn <- pick_season(vul_type = vul_temp, season = aut)
vul_temp_winter <- pick_season(vul_type = vul_temp, season = win)

vul_sm_spring <- pick_season(vul_type = vul_sm, season = spr)
vul_sm_summer <- pick_season(vul_type = vul_sm, season = sum)
vul_sm_autumn <- pick_season(vul_type = vul_sm, season = aut)
vul_sm_winter <- pick_season(vul_type = vul_sm, season = win)

imp_vul_temp_spring <- pick_season(vul_type = imp_vul_temp, season = spr)
imp_vul_temp_summer <- pick_season(vul_type = imp_vul_temp, season = sum)
imp_vul_temp_autumn <- pick_season(vul_type = imp_vul_temp, season = aut)
imp_vul_temp_winter <- pick_season(vul_type = imp_vul_temp, season = win)

imp_vul_sm_spring <- pick_season(vul_type = imp_vul_sm, season = spr)
imp_vul_sm_summer <- pick_season(vul_type = imp_vul_sm, season = sum)
imp_vul_sm_autumn <- pick_season(vul_type = imp_vul_sm, season = aut)
imp_vul_sm_winter <- pick_season(vul_type = imp_vul_sm, season = win)

save(vul_temp, vul_temp_spring, vul_temp_summer, vul_temp_autumn, vul_temp_winter, 
     vul_sm, vul_sm_spring, vul_sm_summer, vul_sm_autumn, vul_sm_winter,
     imp_vul_temp, imp_vul_temp_spring, imp_vul_temp_summer, imp_vul_temp_autumn, imp_vul_temp_winter, 
     imp_vul_sm, imp_vul_sm_spring, imp_vul_sm_summer, imp_vul_sm_autumn, imp_vul_sm_winter, file = paste0(path_workspaces,"Vulnerability_seasonal.RData"))

# Months
imp_vul_temp_Jan <- pick_season(vul_type = imp_vul_temp, season = jan)
imp_vul_temp_Feb <- pick_season(vul_type = imp_vul_temp, season = feb)
imp_vul_temp_Mar <- pick_season(vul_type = imp_vul_temp, season = mar)
imp_vul_temp_Apr <- pick_season(vul_type = imp_vul_temp, season = apr)
imp_vul_temp_May <- pick_season(vul_type = imp_vul_temp, season = may)
imp_vul_temp_Jun <- pick_season(vul_type = imp_vul_temp, season = jun)
imp_vul_temp_Jul <- pick_season(vul_type = imp_vul_temp, season = jul)
imp_vul_temp_Aug <- pick_season(vul_type = imp_vul_temp, season = aug)
imp_vul_temp_Sep <- pick_season(vul_type = imp_vul_temp, season = sep)
imp_vul_temp_Oct <- pick_season(vul_type = imp_vul_temp, season = oct)
imp_vul_temp_Nov <- pick_season(vul_type = imp_vul_temp, season = nov)
imp_vul_temp_Dec <- pick_season(vul_type = imp_vul_temp, season = dec)

imp_vul_sm_Jan <- pick_season(vul_type = imp_vul_sm, season = jan)
imp_vul_sm_Feb <- pick_season(vul_type = imp_vul_sm, season = feb)
imp_vul_sm_Mar <- pick_season(vul_type = imp_vul_sm, season = mar)
imp_vul_sm_Apr <- pick_season(vul_type = imp_vul_sm, season = apr)
imp_vul_sm_May <- pick_season(vul_type = imp_vul_sm, season = may)
imp_vul_sm_Jun <- pick_season(vul_type = imp_vul_sm, season = jun)
imp_vul_sm_Jul <- pick_season(vul_type = imp_vul_sm, season = jul)
imp_vul_sm_Aug <- pick_season(vul_type = imp_vul_sm, season = aug)
imp_vul_sm_Sep <- pick_season(vul_type = imp_vul_sm, season = sep)
imp_vul_sm_Oct <- pick_season(vul_type = imp_vul_sm, season = oct)
imp_vul_sm_Nov <- pick_season(vul_type = imp_vul_sm, season = nov)
imp_vul_sm_Dec <- pick_season(vul_type = imp_vul_sm, season = dec)

save(imp_vul_temp_Jan, imp_vul_temp_Feb, imp_vul_temp_Mar, imp_vul_temp_Apr, imp_vul_temp_May, imp_vul_temp_Jun, 
     imp_vul_temp_Jul, imp_vul_temp_Aug, imp_vul_temp_Sep, imp_vul_temp_Oct, imp_vul_temp_Nov, imp_vul_temp_Dec,
     imp_vul_sm_Jan, imp_vul_sm_Feb, imp_vul_sm_Mar, imp_vul_sm_Apr, imp_vul_sm_May, imp_vul_sm_Jun, 
     imp_vul_sm_Jul, imp_vul_sm_Aug, imp_vul_sm_Sep, imp_vul_sm_Oct, imp_vul_sm_Nov, imp_vul_sm_Dec,
     file = paste0(path_workspaces,"Vulnerability_monthly_mv3_only_driver.RData"))
```